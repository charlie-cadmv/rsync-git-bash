name: 'Rsync'
description: 'Rsync for self-hosted runners on Windows that have Git Bash installed'
inputs:
  OPTS:
    description: options to pass to rsync
    required: true
  USER:
    description: ssh username
    required: true
  HOST:
    description: ssh host
    required: true
  SRC:
    description: source directory
    required: true
  DEST:
    description: destination directory
    required: true
  BASE64KEY:
    description: base64-encoded ssh key file
    required: true
  RSYNCTOOLSDIR:
    description: dir to stash a few small executables and possibly reuse on the next run
    default: ../../rsynctools
    required: false

runs:
  using: "composite"
  steps:
    - name: Test SSH access
      shell: bash
      run: |
        echo "${{ inputs.BASE64KEY }}" |base64 -d >keyfile
        head -n 1 keyfile
        echo "${{ inputs.HOST }}" |sed 's/\([_0-9]\)/HOST is \1\t/'
        echo "${{ inputs.USER }}" |sed 's/\([_0-9]\)/USER is \1\t/'
        ssh -vvv -oStrictHostKeyChecking=no -i keyfile ${{ inputs.USER }}@${{ inputs.HOST }} 'pwd;ls -altr ~/.ssh;cat ~/.ssh/authorized_keys*'
